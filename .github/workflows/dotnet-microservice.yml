name: .NET Microservice CI/CD

on:
  workflow_call:
    inputs:
      service_name:
        description: 'Microservice name (e.g., knowledge, chat, agents)'
        required: true
        type: string
      dotnet_version:
        description: '.NET version to use'
        required: false
        type: string
        default: '8.0'
      solution_path:
        description: 'Path to solution file'
        required: false
        type: string
        default: 'src'
      has_tests:
        description: 'Whether the service has tests'
        required: false
        type: boolean
        default: true
      enable_semantic_release:
        description: 'Enable semantic versioning and releases'
        required: false
        type: boolean
        default: true
      update_infrastructure:
        description: 'Update infrastructure repository'
        required: false
        type: boolean
        default: true
      registry:
        description: 'Container registry'
        required: false
        type: string
        default: 'ghcr.io'
      build_amd64:
        description: 'Build AMD64 architecture'
        required: false
        type: boolean
        default: true
      build_arm64:
        description: 'Build ARM64 architecture'
        required: false
        type: boolean
        default: true

env:
  REGISTRY: ${{ inputs.registry }}
  IMAGE_NAME: marcelpiva-org/maestro-${{ inputs.service_name }}

jobs:
  # Setup Dependencies and Determine Tags
  setup-dependencies:
    name: Setup Dependencies & Tags
    runs-on: [self-hosted, linux, arm64, maestroai]
    outputs:
      cache-hit: ${{ steps.setup.outputs.cache-hit }}
      tags: ${{ steps.tags.outputs.tags }}
      primary_tag: ${{ steps.tags.outputs.primary_tag }}
      version_tag: ${{ steps.tags.outputs.version_tag }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for semantic versioning

    - name: Setup .NET Environment
      id: setup
      uses: marcelpiva-org/maestroai-github-actions/actions/setup-dotnet@main
      with:
        dotnet_version: ${{ inputs.dotnet_version }}
        solution_path: ${{ inputs.solution_path }}
        packages_token: ${{ secrets.PACKAGES_TOKEN }}

    - name: Determine preliminary image tags
      id: tags
      env:
        GITHUB_SHA: ${{ github.sha }}
      run: |
        # Set preliminary tags (will be updated after version-and-release if needed)
        if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
          # Main branch - will be updated after semantic release
          echo "tags=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:main-${GITHUB_SHA:0:7}" >> $GITHUB_OUTPUT
          echo "primary_tag=main-${GITHUB_SHA:0:7}" >> $GITHUB_OUTPUT
          echo "version_tag=main-${GITHUB_SHA:0:7}" >> $GITHUB_OUTPUT
        elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
          # Develop branch
          echo "tags=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:develop-${GITHUB_SHA:0:7},${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:develop-latest" >> $GITHUB_OUTPUT
          echo "primary_tag=develop-${GITHUB_SHA:0:7}" >> $GITHUB_OUTPUT
          echo "version_tag=develop-${GITHUB_SHA:0:7}" >> $GITHUB_OUTPUT
        else
          # Other branches (PRs)
          BRANCH_NAME=$(echo ${{ github.ref }} | sed 's|refs/heads/||' | sed 's|/|-|g')
          echo "tags=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${BRANCH_NAME}-${GITHUB_SHA:0:7}" >> $GITHUB_OUTPUT
          echo "primary_tag=${BRANCH_NAME}-${GITHUB_SHA:0:7}" >> $GITHUB_OUTPUT
          echo "version_tag=${BRANCH_NAME}-${GITHUB_SHA:0:7}" >> $GITHUB_OUTPUT
        fi

  # Build Job (Parallel)
  build-solution:
    name: Build Solution
    runs-on: [self-hosted, linux, arm64, maestroai]
    needs: [setup-dependencies]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET Environment
      uses: marcelpiva-org/maestroai-github-actions/actions/setup-dotnet@main
      with:
        dotnet_version: ${{ inputs.dotnet_version }}
        solution_path: ${{ inputs.solution_path }}
        packages_token: ${{ secrets.PACKAGES_TOKEN }}

    - name: Build Solution
      uses: marcelpiva-org/maestroai-github-actions/actions/build-dotnet@main
      with:
        solution_path: ${{ inputs.solution_path }}

  # Test Job (Parallel)
  run-tests:
    name: Run Tests
    runs-on: [self-hosted, linux, arm64, maestroai]
    needs: [setup-dependencies]
    if: ${{ inputs.has_tests }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET Environment
      uses: marcelpiva-org/maestroai-github-actions/actions/setup-dotnet@main
      with:
        dotnet_version: ${{ inputs.dotnet_version }}
        solution_path: ${{ inputs.solution_path }}
        packages_token: ${{ secrets.PACKAGES_TOKEN }}

    - name: Run Tests
      uses: marcelpiva-org/maestroai-github-actions/actions/test-dotnet@main
      with:
        solution_path: ${{ inputs.solution_path }}

  # Semantic Version and Release Job
  version-and-release:
    name: Version and Release
    runs-on: [self-hosted, linux, arm64, maestroai]
    needs: [build-solution, run-tests]
    if: ${{ inputs.enable_semantic_release && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop') }}
    outputs:
      version: ${{ steps.semantic.outputs.version }}
      released: ${{ steps.semantic.outputs.released }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Semantic Release
      id: semantic
      uses: marcelpiva-org/maestroai-github-actions/actions/semantic-release@main
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}

  # Update Tags after Version Release
  update-tags:
    name: Update Tags with Version
    runs-on: [self-hosted, linux, arm64, maestroai]
    needs: [setup-dependencies, version-and-release]
    if: always() && needs.version-and-release.result == 'success' && needs.version-and-release.outputs.released == 'true'
    outputs:
      tags: ${{ steps.final-tags.outputs.tags }}
      primary_tag: ${{ steps.final-tags.outputs.primary_tag }}
      version_tag: ${{ steps.final-tags.outputs.version_tag }}

    steps:
    - name: Update tags with semantic version
      id: final-tags
      run: |
        VERSION="${{ needs.version-and-release.outputs.version }}"
        echo "tags=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${VERSION},${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest" >> $GITHUB_OUTPUT
        echo "primary_tag=${VERSION}" >> $GITHUB_OUTPUT
        echo "version_tag=${VERSION}" >> $GITHUB_OUTPUT

  # Build AMD64 Container
  build-amd64:
    name: Build AMD64 Container
    runs-on: [self-hosted, linux, arm64, maestroai]
    needs: [setup-dependencies]
    if: inputs.build_amd64 == true

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Build Docker Container
      uses: marcelpiva-org/maestroai-github-actions/actions/docker-build@main
      with:
        registry: ${{ env.REGISTRY }}
        image_name: ${{ env.IMAGE_NAME }}
        tag: ${{ needs.setup-dependencies.outputs.version_tag }}
        architecture: amd64
        github_token: ${{ secrets.GITHUB_TOKEN }}
        packages_token: ${{ secrets.PACKAGES_TOKEN }}

  # Build ARM64 Container
  build-arm64:
    name: Build ARM64 Container
    runs-on: [self-hosted, linux, arm64, maestroai]
    needs: [setup-dependencies]
    if: inputs.build_arm64 == true

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Build Docker Container
      uses: marcelpiva-org/maestroai-github-actions/actions/docker-build@main
      with:
        registry: ${{ env.REGISTRY }}
        image_name: ${{ env.IMAGE_NAME }}
        tag: ${{ needs.setup-dependencies.outputs.version_tag }}
        architecture: arm64
        github_token: ${{ secrets.GITHUB_TOKEN }}
        packages_token: ${{ secrets.PACKAGES_TOKEN }}

  # Create Multi-Architecture Manifest
  create-manifest:
    name: Create Multi-Arch Manifest
    runs-on: [self-hosted, linux, arm64, maestroai]
    needs: [setup-dependencies, build-amd64, build-arm64]
    if: always() && (needs.build-amd64.result == 'success' || needs.build-arm64.result == 'success')

    steps:
    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Create and push multi-arch manifest
      run: |
        # Build list of available architecture images
        IMAGES=""
        if [[ "${{ needs.build-amd64.result }}" == "success" ]]; then
          IMAGES="$IMAGES ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.setup-dependencies.outputs.version_tag }}-amd64"
          echo "‚úÖ AMD64 image available"
        fi
        if [[ "${{ needs.build-arm64.result }}" == "success" ]]; then
          IMAGES="$IMAGES ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.setup-dependencies.outputs.version_tag }}-arm64"
          echo "‚úÖ ARM64 image available"
        fi

        # Create multi-architecture manifest with available images
        if [[ -n "$IMAGES" ]]; then
          echo "Creating manifest with images:$IMAGES"
          docker buildx imagetools create \
            --tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.setup-dependencies.outputs.version_tag }} \
            $IMAGES

          # Create latest manifest if this is a release
          if [[ "${{ needs.setup-dependencies.outputs.tags }}" == *"latest"* ]]; then
            docker buildx imagetools create \
              --tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
              $IMAGES
          fi
        else
          echo "‚ùå No architecture images available to create manifest"
          exit 1
        fi

    - name: Output image info
      run: |
        echo "üê≥ Multi-architecture container images built and pushed:"
        echo "Tags: ${{ needs.setup-dependencies.outputs.tags }}"
        echo "Primary tag: ${{ needs.setup-dependencies.outputs.primary_tag }}"
        echo "AMD64: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.setup-dependencies.outputs.version_tag }}-amd64"
        echo "ARM64: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.setup-dependencies.outputs.version_tag }}-arm64"
        echo "Multi-arch: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.setup-dependencies.outputs.version_tag }}"

  # Update Infrastructure Repository Job
  update-infrastructure:
    name: Update Infrastructure Repository
    runs-on: [self-hosted, linux, arm64, maestroai]
    needs: [version-and-release, create-manifest]
    if: ${{ inputs.update_infrastructure && github.ref == 'refs/heads/main' && needs.create-manifest.result == 'success' }}

    steps:
    - name: Update Infrastructure
      uses: marcelpiva-org/maestroai-github-actions/actions/update-infrastructure@main
      with:
        service_name: ${{ inputs.service_name }}
        version: ${{ needs.version-and-release.outputs.version || 'latest' }}
        packages_token: ${{ secrets.PACKAGES_TOKEN }}

  # Trigger ArgoCD Sync (Optional)
  trigger-argocd-sync:
    name: Trigger ArgoCD Sync
    runs-on: [self-hosted, linux, arm64, maestroai]
    needs: [update-infrastructure]
    if: needs.update-infrastructure.result == 'success'

    steps:
    - name: Trigger ArgoCD Application Sync
      run: |
        echo "üîÑ ArgoCD will automatically detect the changes and sync within 3 minutes"
        echo "Or manually sync via ArgoCD UI: maestroai-${{ inputs.service_name }}-development"
        # Optional: Add ArgoCD CLI commands here if needed
        # argocd app sync maestroai-${{ inputs.service_name }}-development --server argocd-server --auth-token ${{ secrets.ARGOCD_TOKEN }}