name: .NET CI Complete (Develop Branch)

# Gatilho: merge em develop
# Objetivo: CI completo + deploy em Dev (<20min)
# Escopo: Unit + Integration Tests, Multi-Arch Build, Full Security Scan, Deploy Dev
# Artefatos: Containers AMD64 + ARM64, Coverage Reports, Security Reports

on:
  workflow_call:
    inputs:
      service_name:
        description: 'Microservice name (e.g., knowledge, chat, agents)'
        required: true
        type: string
      dotnet_version:
        description: '.NET version to use'
        required: false
        type: string
        default: '8.0'
      solution_path:
        description: 'Path to solution file'
        required: false
        type: string
        default: 'src'
      has_tests:
        description: 'Whether the service has tests'
        required: false
        type: boolean
        default: true
      has_integration_tests:
        description: 'Whether the service has integration tests'
        required: false
        type: boolean
        default: false
      enable_contract_tests:
        description: 'Enable contract testing between services'
        required: false
        type: boolean
        default: false
      deploy_to_dev:
        description: 'Automatically deploy to Dev environment'
        required: false
        type: boolean
        default: true
      registry:
        description: 'Container registry'
        required: false
        type: string
        default: 'ghcr.io'

permissions:
  contents: read
  packages: write
  security-events: write

env:
  REGISTRY: ${{ inputs.registry }}
  IMAGE_NAME: marcelpiva-org/maestro-${{ inputs.service_name }}-app

jobs:
  # ========================================
  # Job 1: Setup Dependencies
  # ========================================
  setup-dependencies:
    name: ðŸ”§ Setup Dependencies & Tags
    runs-on: ubuntu-latest
    outputs:
      cache-hit: ${{ steps.setup.outputs.cache-hit }}
      tag: ${{ steps.tag.outputs.tag }}
      version: ${{ steps.tag.outputs.version }}

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for versioning

    - name: ðŸ”§ Setup .NET Environment
      id: setup
      uses: marcelpiva-org/maestroai-github-actions/actions/setup-dotnet@main
      with:
        dotnet_version: ${{ inputs.dotnet_version }}
        solution_path: ${{ inputs.solution_path }}
        packages_token: ${{ secrets.PACKAGES_TOKEN }}

    - name: ðŸ·ï¸ Generate develop tags
      id: tag
      run: |
        SHA_SHORT="${GITHUB_SHA:0:7}"
        TAG="develop-${SHA_SHORT}"
        VERSION="develop-$(date +%Y%m%d)-${SHA_SHORT}"

        echo "tag=${TAG}" >> $GITHUB_OUTPUT
        echo "version=${VERSION}" >> $GITHUB_OUTPUT

        echo "ðŸ“¦ Develop tag: ${TAG}"
        echo "ðŸ“¦ Version: ${VERSION}"

  # ========================================
  # Job 2: Build Solution (Parallel)
  # ========================================
  build-solution:
    name: ðŸ—ï¸ Build Solution
    runs-on: ubuntu-latest
    needs: [setup-dependencies]

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup .NET Environment
      uses: marcelpiva-org/maestroai-github-actions/actions/setup-dotnet@main
      with:
        dotnet_version: ${{ inputs.dotnet_version }}
        solution_path: ${{ inputs.solution_path }}
        packages_token: ${{ secrets.PACKAGES_TOKEN }}

    - name: ðŸ—ï¸ Build Solution
      uses: marcelpiva-org/maestroai-github-actions/actions/build-dotnet@main
      with:
        solution_path: ${{ inputs.solution_path }}

  # ========================================
  # Job 3: Unit Tests (Parallel)
  # ========================================
  unit-tests:
    name: ðŸ§ª Unit Tests
    runs-on: ubuntu-latest
    needs: [setup-dependencies]
    if: ${{ inputs.has_tests }}

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup .NET Environment
      uses: marcelpiva-org/maestroai-github-actions/actions/setup-dotnet@main
      with:
        dotnet_version: ${{ inputs.dotnet_version }}
        solution_path: ${{ inputs.solution_path }}
        packages_token: ${{ secrets.PACKAGES_TOKEN }}

    - name: ðŸ§ª Run Unit Tests with Coverage
      run: |
        echo "ðŸ§ª Running unit tests with coverage..."
        dotnet test ${{ inputs.solution_path }} \
          --configuration Release \
          --no-build \
          --collect:"XPlat Code Coverage" \
          --results-directory ./coverage \
          -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=opencover

        echo "âœ… Unit tests completed"

    - name: ðŸ“Š Upload Coverage Report
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report-${{ github.sha }}
        path: ./coverage
        retention-days: 30

  # ========================================
  # Job 4: Integration Tests (If Enabled)
  # ========================================
  integration-tests:
    name: ðŸ”— Integration Tests
    runs-on: ubuntu-latest
    needs: [setup-dependencies]
    if: ${{ inputs.has_integration_tests }}

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: maestroai_test
          POSTGRES_USER: maestroai_test
          POSTGRES_PASSWORD: test_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup .NET Environment
      uses: marcelpiva-org/maestroai-github-actions/actions/setup-dotnet@main
      with:
        dotnet_version: ${{ inputs.dotnet_version }}
        solution_path: ${{ inputs.solution_path }}
        packages_token: ${{ secrets.PACKAGES_TOKEN }}

    - name: ðŸ—„ï¸ Run Database Migrations (Dry Run)
      run: |
        echo "ðŸ—„ï¸ Running database migrations in dry-run mode..."
        # Add your migration command here
        echo "âœ… Migrations validated"

    - name: ðŸ”— Run Integration Tests
      env:
        ConnectionStrings__DefaultConnection: "Host=localhost;Port=5432;Database=maestroai_test;Username=maestroai_test;Password=test_password"
        Redis__ConnectionString: "localhost:6379"
      run: |
        echo "ðŸ”— Running integration tests..."
        dotnet test ${{ inputs.solution_path }} \
          --filter "Category=Integration" \
          --configuration Release \
          --no-build \
          --logger "trx;LogFileName=integration-tests.trx"

        echo "âœ… Integration tests completed"

    - name: ðŸ“Š Upload Integration Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: integration-test-results-${{ github.sha }}
        path: "**/integration-tests.trx"
        retention-days: 30

  # ========================================
  # Job 5: Contract Tests (If Enabled)
  # ========================================
  contract-tests:
    name: ðŸ“œ Contract Tests
    runs-on: ubuntu-latest
    needs: [setup-dependencies]
    if: ${{ inputs.enable_contract_tests }}

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup .NET Environment
      uses: marcelpiva-org/maestroai-github-actions/actions/setup-dotnet@main
      with:
        dotnet_version: ${{ inputs.dotnet_version }}
        solution_path: ${{ inputs.solution_path }}
        packages_token: ${{ secrets.PACKAGES_TOKEN }}

    - name: ðŸ“œ Run Contract Tests (Pact)
      run: |
        echo "ðŸ“œ Running contract tests..."
        # Add Pact contract testing here
        echo "âœ… Contract tests completed"

  # ========================================
  # Job 6: Build Multi-Arch Containers
  # ========================================
  build-amd64:
    name: ðŸ³ Build AMD64 Container
    runs-on: ubuntu-latest
    needs: [setup-dependencies, build-solution, unit-tests]

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ³ Build Docker Container
      uses: marcelpiva-org/maestroai-github-actions/actions/docker-build@main
      with:
        registry: ${{ env.REGISTRY }}
        image_name: ${{ env.IMAGE_NAME }}
        tag: ${{ needs.setup-dependencies.outputs.tag }}
        architecture: amd64
        github_token: ${{ secrets.GITHUB_TOKEN }}
        packages_token: ${{ secrets.PACKAGES_TOKEN }}
        registry_username: marcelpiva-org

  build-arm64:
    name: ðŸ³ Build ARM64 Container
    runs-on: ubuntu-latest
    needs: [setup-dependencies, build-solution, unit-tests]

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ³ Build Docker Container
      uses: marcelpiva-org/maestroai-github-actions/actions/docker-build@main
      with:
        registry: ${{ env.REGISTRY }}
        image_name: ${{ env.IMAGE_NAME }}
        tag: ${{ needs.setup-dependencies.outputs.tag }}
        architecture: arm64
        github_token: ${{ secrets.GITHUB_TOKEN }}
        packages_token: ${{ secrets.PACKAGES_TOKEN }}
        registry_username: marcelpiva-org

  # ========================================
  # Job 7: Create Multi-Arch Manifest
  # ========================================
  create-manifest:
    name: ðŸ“¦ Create Multi-Arch Manifest
    runs-on: ubuntu-latest
    needs: [setup-dependencies, build-amd64, build-arm64]
    if: always() && (needs.build-amd64.result == 'success' || needs.build-arm64.result == 'success')

    steps:
    - name: ðŸ” Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: ðŸ“¦ Create and push multi-arch manifest
      run: |
        IMAGES=""
        if [[ "${{ needs.build-amd64.result }}" == "success" ]]; then
          IMAGES="$IMAGES ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.setup-dependencies.outputs.tag }}-amd64"
          echo "âœ… AMD64 image available"
        fi
        if [[ "${{ needs.build-arm64.result }}" == "success" ]]; then
          IMAGES="$IMAGES ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.setup-dependencies.outputs.tag }}-arm64"
          echo "âœ… ARM64 image available"
        fi

        if [[ -n "$IMAGES" ]]; then
          echo "ðŸ“¦ Creating multi-arch manifest..."
          docker buildx imagetools create \
            --tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.setup-dependencies.outputs.tag }} \
            --tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:develop-latest \
            $IMAGES

          echo "âœ… Multi-arch manifest created"
        else
          echo "âŒ No images available"
          exit 1
        fi

  # ========================================
  # Job 8: Security Tier Detection
  # ========================================
  check-security-tier:
    name: ðŸ”’ Check Security Tier
    runs-on: ubuntu-latest
    needs: [setup-dependencies, create-manifest]
    if: always() && needs.create-manifest.result == 'success'
    outputs:
      has-advanced-security: ${{ steps.check.outputs.has_advanced_security }}

    steps:
    - name: ðŸ” Check if repository has Advanced Security
      id: check
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        is_public=$(gh api "/repos/${{ github.repository }}" --jq '.private' | grep -q 'false' && echo "true" || echo "false")

        if [ "$is_public" = "true" ]; then
          echo "has_advanced_security=true" >> $GITHUB_OUTPUT
          echo "âœ… Public repository - Advanced Security available"
        else
          echo "has_advanced_security=false" >> $GITHUB_OUTPUT
          echo "âš ï¸  Private repository - Advanced Security requires GitHub Team/Enterprise"
        fi

  # ========================================
  # Job 9: Trivy Container Scan
  # ========================================
  trivy-scan:
    name: ðŸ”’ Trivy Container Scan
    runs-on: ubuntu-latest
    needs: [setup-dependencies, create-manifest, check-security-tier]
    if: always() && needs.create-manifest.result == 'success'
    permissions:
      contents: read
      security-events: write
      actions: read
      packages: read

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ”’ Run Trivy scan
      uses: marcelpiva-org/maestroai-github-actions/actions/trivy-scan@main
      with:
        image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.setup-dependencies.outputs.tag }}
        severity: 'CRITICAL,HIGH,MEDIUM'
        exit_code: '0'
        format: 'sarif'
        output_file: 'trivy-results.sarif'
        upload_sarif: ${{ needs.check-security-tier.outputs.has-advanced-security }}
        registry_username: ${{ github.actor }}
        registry_password: ${{ secrets.GITHUB_TOKEN }}

  # ========================================
  # Job 10: Deploy to Dev Environment
  # ========================================
  deploy-to-dev:
    name: ðŸš€ Deploy to Dev
    runs-on: ubuntu-latest
    needs: [setup-dependencies, create-manifest, trivy-scan]
    if: ${{ inputs.deploy_to_dev && needs.create-manifest.result == 'success' }}

    steps:
    - name: ðŸ“¥ Checkout infrastructure repo
      uses: actions/checkout@v4
      with:
        repository: marcelpiva-org/maestroai-infrastructure
        token: ${{ secrets.PACKAGES_TOKEN }}
        path: infrastructure

    - name: ðŸ“ Update Dev deployment manifest
      run: |
        cd infrastructure

        echo "ðŸ“ Updating ${{ inputs.service_name }} deployment in Dev environment..."

        # Update image tag in ArgoCD application
        sed -i "s|image: .*maestro-${{ inputs.service_name }}-app:.*|image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.setup-dependencies.outputs.tag }}|g" \
          k8s/overlays/dev/${{ inputs.service_name }}/deployment.yaml || true

        echo "âœ… Manifest updated"

    - name: ðŸš€ Commit and push changes
      run: |
        cd infrastructure

        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

        git add .
        git commit -m "chore(dev): update ${{ inputs.service_name }} to ${{ needs.setup-dependencies.outputs.tag }}

        Automated deployment from develop branch

        ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)" || {
          echo "â„¹ï¸  No changes to commit"
          exit 0
        }

        git push

    - name: ðŸ”„ Trigger ArgoCD Sync
      run: |
        echo "ðŸ”„ ArgoCD will automatically detect changes and sync within 3 minutes"
        echo "ðŸ“ Application: maestroai-${{ inputs.service_name }}-dev"
        echo "ðŸŒ URL: https://${{ inputs.service_name }}-dev.maestroai"

    - name: ðŸ§ª Run Smoke Tests
      run: |
        echo "ðŸ§ª Waiting for deployment to stabilize..."
        sleep 30

        echo "ðŸ” Running smoke tests..."
        curl -f -s "https://${{ inputs.service_name }}-dev.maestroai/health/live" || {
          echo "âŒ Smoke test failed - service not responding"
          exit 1
        }

        echo "âœ… Smoke tests passed"

  # ========================================
  # Job 11: Summary
  # ========================================
  summary:
    name: ðŸ“Š Pipeline Summary
    runs-on: ubuntu-latest
    needs: [setup-dependencies, build-solution, unit-tests, integration-tests, create-manifest, trivy-scan, deploy-to-dev]
    if: always()

    steps:
    - name: ðŸ“Š Generate Summary
      run: |
        cat >> $GITHUB_STEP_SUMMARY << EOF
        ## ðŸš€ CI Complete - Develop Branch

        **Service**: \`${{ inputs.service_name }}\`
        **Tag**: \`${{ needs.setup-dependencies.outputs.tag }}\`
        **Version**: \`${{ needs.setup-dependencies.outputs.version }}\`

        ### âœ… Pipeline Results

        | Stage | Status | Duration |
        |-------|--------|----------|
        | ðŸ”§ Setup | ${{ needs.setup-dependencies.result == 'success' && 'âœ…' || 'âŒ' }} | ~30s |
        | ðŸ—ï¸ Build | ${{ needs.build-solution.result == 'success' && 'âœ…' || 'âŒ' }} | ~1min |
        | ðŸ§ª Unit Tests | ${{ needs.unit-tests.result == 'success' && 'âœ…' || 'â­ï¸' }} | ~2min |
        | ðŸ”— Integration Tests | ${{ needs.integration-tests.result == 'success' && 'âœ…' || 'â­ï¸' }} | ~3min |
        | ðŸ³ Containers (AMD64 + ARM64) | ${{ needs.create-manifest.result == 'success' && 'âœ…' || 'âŒ' }} | ~5min |
        | ðŸ”’ Security Scan | ${{ needs.trivy-scan.result == 'success' && 'âœ…' || 'âŒ' }} | ~2min |
        | ðŸš€ Deploy to Dev | ${{ needs.deploy-to-dev.result == 'success' && 'âœ…' || 'â­ï¸' }} | ~2min |

        **Total Duration**: ~15-20min

        ### ðŸ³ Container Images

        - **AMD64**: \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.setup-dependencies.outputs.tag }}-amd64\`
        - **ARM64**: \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.setup-dependencies.outputs.tag }}-arm64\`
        - **Multi-Arch**: \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.setup-dependencies.outputs.tag }}\`
        - **Latest**: \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:develop-latest\`

        ### ðŸŒ Dev Environment

        **URL**: https://${{ inputs.service_name }}-dev.maestroai
        **ArgoCD**: maestroai-${{ inputs.service_name }}-dev

        ---

        <sub>ðŸ¤– Generated by CI Complete Pipeline</sub>
        EOF
