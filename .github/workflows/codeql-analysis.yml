name: CodeQL Security Analysis

# Reusable workflow for CodeQL code scanning
# Detects security vulnerabilities and coding errors in .NET code
#
# Usage in your repository's .github/workflows/codeql.yml:
#
# name: CodeQL
# on:
#   push:
#     branches: [main, develop]
#   pull_request:
#     branches: [main, develop]
#   schedule:
#     - cron: '0 6 * * 1'  # Weekly on Mondays at 6 AM
# jobs:
#   analyze:
#     uses: marcelpiva-org/maestroai-github-actions/.github/workflows/codeql-analysis.yml@main

on:
  workflow_call:
    inputs:
      language:
        description: 'Programming language to analyze (csharp, javascript, etc)'
        required: false
        type: string
        default: 'csharp'
      queries:
        description: 'CodeQL query suite to use'
        required: false
        type: string
        default: 'security-and-quality'

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  check-tier:
    name: Check GitHub Tier
    runs-on: arc-runner-set
    outputs:
      is-paid: ${{ steps.check.outputs.is_paid }}
    steps:
    - name: Check if repository has CodeQL enabled
      id: check
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        # CodeQL requires GitHub Advanced Security (GitHub Team, Enterprise Cloud, or Enterprise Server)
        # Free tier private repos don't have access to CodeQL

        # Try to check if Advanced Security is enabled
        is_public=$(gh api "/repos/${{ github.repository }}" --jq '.private' | grep -q 'false' && echo "true" || echo "false")

        if [ "$is_public" = "true" ]; then
          echo "is_paid=true" >> $GITHUB_OUTPUT
          echo "‚úÖ Public repository - CodeQL available"
        else
          echo "is_paid=false" >> $GITHUB_OUTPUT
          echo "‚ö†Ô∏è  Private repository - CodeQL requires GitHub Advanced Security (paid tier)"
          echo "Skipping CodeQL analysis to avoid quota/billing issues"
        fi

  analyze:
    name: CodeQL Analysis (${{ inputs.language }})
    runs-on: arc-runner-set
    needs: check-tier
    if: needs.check-tier.outputs.is-paid == 'true'
    timeout-minutes: 30

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: ${{ inputs.language }}
        queries: ${{ inputs.queries }}
        # Custom queries can be added here
        # queries: +security-and-quality,security-extended

    - name: Setup .NET (for C# analysis)
      if: inputs.language == 'csharp'
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Restore dependencies (C#)
      if: inputs.language == 'csharp'
      run: |
        if [ -f "*.sln" ]; then
          dotnet restore *.sln
        else
          find . -name "*.csproj" -exec dotnet restore {} \;
        fi

    - name: Build solution (C#)
      if: inputs.language == 'csharp'
      run: |
        if [ -f "*.sln" ]; then
          dotnet build *.sln --no-restore --configuration Release
        else
          find . -name "*.csproj" -exec dotnet build {} --no-restore --configuration Release \;
        fi

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      with:
        category: "/language:${{ inputs.language }}"
        upload: true

    - name: Display results summary
      if: always()
      run: |
        echo "üîç CodeQL Analysis Completed"
        echo "Language: ${{ inputs.language }}"
        echo "Queries: ${{ inputs.queries }}"
        echo ""
        echo "üìä Results uploaded to GitHub Security tab"
        echo "View at: ${{ github.server_url }}/${{ github.repository }}/security/code-scanning"
