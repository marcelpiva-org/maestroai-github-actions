name: 'SonarCloud Scan for .NET'
description: 'Run SonarCloud SAST analysis on .NET projects with code quality and security insights'

inputs:
  sonar_token:
    description: 'SonarCloud authentication token'
    required: true
  sonar_organization:
    description: 'SonarCloud organization name'
    required: true
  sonar_project_key:
    description: 'SonarCloud project key'
    required: true
  dotnet_version:
    description: '.NET SDK version'
    required: false
    default: '8.0'
  solution_path:
    description: 'Path to .NET solution or project'
    required: false
    default: 'src'
  coverage_exclusions:
    description: 'Paths to exclude from coverage (comma-separated)'
    required: false
    default: '**/Program.cs,**/Startup.cs,**/*Tests/**'
  skip_analysis:
    description: 'Skip analysis (for testing)'
    required: false
    default: 'false'

outputs:
  quality_gate_status:
    description: 'Quality Gate status (PASSED/FAILED/WARN/NONE)'
    value: ${{ steps.sonar-end.outputs.quality_gate_status }}

runs:
  using: 'composite'
  steps:
    - name: ğŸ” Check if SonarCloud analysis should run
      id: check-skip
      shell: bash
      run: |
        if [[ "${{ inputs.skip_analysis }}" == "true" ]]; then
          echo "â­ï¸  Skipping SonarCloud analysis (skip_analysis=true)"
          echo "skip=true" >> $GITHUB_OUTPUT
        else
          echo "skip=false" >> $GITHUB_OUTPUT
        fi

    - name: ğŸ”§ Setup .NET SDK
      if: steps.check-skip.outputs.skip == 'false'
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ inputs.dotnet_version }}

    - name: ğŸ“¦ Install SonarScanner for .NET
      if: steps.check-skip.outputs.skip == 'false'
      shell: bash
      run: |
        echo "ğŸ“¦ Installing SonarScanner for .NET..."
        dotnet tool install --global dotnet-sonarscanner --version 6.0.0 || dotnet tool update --global dotnet-sonarscanner
        echo "âœ… SonarScanner installed"

    - name: ğŸ“¦ Install Coverage Tools
      if: steps.check-skip.outputs.skip == 'false'
      shell: bash
      run: |
        echo "ğŸ“¦ Installing dotnet-coverage..."
        dotnet tool install --global dotnet-coverage || dotnet tool update --global dotnet-coverage
        echo "âœ… Coverage tools installed"

    - name: ğŸ”„ Restore Dependencies
      if: steps.check-skip.outputs.skip == 'false'
      shell: bash
      run: |
        echo "ğŸ”„ Restoring NuGet packages..."
        dotnet restore ${{ inputs.solution_path }}
        echo "âœ… Dependencies restored"

    - name: ğŸš€ Begin SonarCloud Analysis
      if: steps.check-skip.outputs.skip == 'false'
      shell: bash
      env:
        SONAR_TOKEN: ${{ inputs.sonar_token }}
      run: |
        echo "ğŸš€ Starting SonarCloud analysis..."

        dotnet sonarscanner begin \
          /k:"${{ inputs.sonar_project_key }}" \
          /o:"${{ inputs.sonar_organization }}" \
          /d:sonar.host.url="https://sonarcloud.io" \
          /d:sonar.token="${SONAR_TOKEN}" \
          /d:sonar.cs.vscoveragexml.reportsPaths="coverage.xml" \
          /d:sonar.coverage.exclusions="${{ inputs.coverage_exclusions }}"

        echo "âœ… SonarCloud analysis initialized"

    - name: ğŸ—ï¸ Build Solution
      if: steps.check-skip.outputs.skip == 'false'
      shell: bash
      run: |
        echo "ğŸ—ï¸ Building solution..."
        dotnet build ${{ inputs.solution_path }} --configuration Release --no-restore
        echo "âœ… Build completed"

    - name: ğŸ§ª Run Tests with Coverage
      if: steps.check-skip.outputs.skip == 'false'
      shell: bash
      run: |
        echo "ğŸ§ª Running tests with code coverage..."

        dotnet-coverage collect \
          "dotnet test ${{ inputs.solution_path }} --configuration Release --no-build --verbosity minimal" \
          -f xml \
          -o "coverage.xml"

        echo "âœ… Tests completed with coverage"

    - name: ğŸ End SonarCloud Analysis
      if: steps.check-skip.outputs.skip == 'false'
      id: sonar-end
      shell: bash
      env:
        SONAR_TOKEN: ${{ inputs.sonar_token }}
      run: |
        echo "ğŸ Finishing SonarCloud analysis..."

        dotnet sonarscanner end /d:sonar.token="${SONAR_TOKEN}"

        echo "âœ… SonarCloud analysis completed"
        echo "quality_gate_status=NONE" >> $GITHUB_OUTPUT

    - name: ğŸ“Š Display Results
      if: steps.check-skip.outputs.skip == 'false'
      shell: bash
      run: |
        echo "ğŸ“Š SonarCloud Analysis Complete"
        echo ""
        echo "ğŸ”— View detailed results at:"
        echo "   https://sonarcloud.io/project/overview?id=${{ inputs.sonar_project_key }}"
        echo ""
        echo "ğŸ“ˆ Quality metrics will appear in ~1-2 minutes"

    - name: â­ï¸ Skipped Analysis
      if: steps.check-skip.outputs.skip == 'true'
      shell: bash
      run: |
        echo "â­ï¸  SonarCloud analysis was skipped"
        echo "â„¹ï¸  To enable, set skip_analysis=false"

branding:
  icon: 'shield'
  color: 'orange'
