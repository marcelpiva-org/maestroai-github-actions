name: 'Sonar Scan for .NET'
description: 'Run Sonar SAST analysis (SonarCloud or SonarQube) on .NET projects with code quality and security insights'

inputs:
  sonar_token:
    description: 'Sonar authentication token'
    required: true
  sonar_host_url:
    description: 'Sonar server URL (default: SonarCloud)'
    required: false
    default: 'https://sonarcloud.io'
  sonar_organization:
    description: 'SonarCloud organization name (only for SonarCloud)'
    required: false
    default: ''
  sonar_project_key:
    description: 'Sonar project key'
    required: true
  dotnet_version:
    description: '.NET SDK version'
    required: false
    default: '8.0'
  solution_path:
    description: 'Path to .NET solution or project'
    required: false
    default: 'src'
  coverage_exclusions:
    description: 'Paths to exclude from coverage (comma-separated)'
    required: false
    default: '**/Program.cs,**/Startup.cs,**/*Tests/**'
  skip_analysis:
    description: 'Skip analysis (for testing)'
    required: false
    default: 'false'

outputs:
  quality_gate_status:
    description: 'Quality Gate status (PASSED/FAILED/WARN/NONE)'
    value: ${{ steps.sonar-end.outputs.quality_gate_status }}
  sonar_type:
    description: 'Sonar type used (SonarCloud or SonarQube)'
    value: ${{ steps.detect-sonar-type.outputs.sonar_type }}

runs:
  using: 'composite'
  steps:
    - name: ğŸ” Detect Sonar Type
      id: detect-sonar-type
      shell: bash
      run: |
        if [[ "${{ inputs.sonar_host_url }}" == "https://sonarcloud.io" ]]; then
          echo "sonar_type=SonarCloud" >> $GITHUB_OUTPUT
          echo "is_sonarcloud=true" >> $GITHUB_OUTPUT
          echo "âœ… Detected: SonarCloud"
        else
          echo "sonar_type=SonarQube" >> $GITHUB_OUTPUT
          echo "is_sonarcloud=false" >> $GITHUB_OUTPUT
          echo "âœ… Detected: SonarQube (self-hosted)"
          echo "   Server: ${{ inputs.sonar_host_url }}"
        fi

    - name: ğŸ” Check if Sonar analysis should run
      id: check-skip
      shell: bash
      run: |
        if [[ "${{ inputs.skip_analysis }}" == "true" ]]; then
          echo "â­ï¸  Skipping Sonar analysis (skip_analysis=true)"
          echo "skip=true" >> $GITHUB_OUTPUT
        else
          echo "skip=false" >> $GITHUB_OUTPUT
        fi

    - name: ğŸ”§ Setup .NET SDK
      if: steps.check-skip.outputs.skip == 'false'
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ inputs.dotnet_version }}

    - name: ğŸ“¦ Install SonarScanner for .NET
      if: steps.check-skip.outputs.skip == 'false'
      shell: bash
      run: |
        echo "ğŸ“¦ Installing SonarScanner for .NET..."
        dotnet tool install --global dotnet-sonarscanner --version 6.0.0 || dotnet tool update --global dotnet-sonarscanner
        echo "âœ… SonarScanner installed"

    - name: ğŸ“¦ Install Coverage Tools
      if: steps.check-skip.outputs.skip == 'false'
      shell: bash
      run: |
        echo "ğŸ“¦ Installing dotnet-coverage..."
        dotnet tool install --global dotnet-coverage || dotnet tool update --global dotnet-coverage
        echo "âœ… Coverage tools installed"

    - name: ğŸ”„ Restore Dependencies
      if: steps.check-skip.outputs.skip == 'false'
      shell: bash
      run: |
        echo "ğŸ”„ Restoring NuGet packages..."
        dotnet restore ${{ inputs.solution_path }}
        echo "âœ… Dependencies restored"

    - name: ğŸš€ Begin Sonar Analysis (SonarCloud)
      if: steps.check-skip.outputs.skip == 'false' && steps.detect-sonar-type.outputs.is_sonarcloud == 'true'
      shell: bash
      env:
        SONAR_TOKEN: ${{ inputs.sonar_token }}
      run: |
        echo "ğŸš€ Starting SonarCloud analysis..."

        if [[ -z "${{ inputs.sonar_organization }}" ]]; then
          echo "âŒ Error: sonar_organization is required for SonarCloud"
          exit 1
        fi

        dotnet sonarscanner begin \
          /k:"${{ inputs.sonar_project_key }}" \
          /o:"${{ inputs.sonar_organization }}" \
          /d:sonar.host.url="${{ inputs.sonar_host_url }}" \
          /d:sonar.token="${SONAR_TOKEN}" \
          /d:sonar.cs.vscoveragexml.reportsPaths="coverage.xml" \
          /d:sonar.coverage.exclusions="${{ inputs.coverage_exclusions }}"

        echo "âœ… SonarCloud analysis initialized"

    - name: ğŸš€ Begin Sonar Analysis (SonarQube)
      if: steps.check-skip.outputs.skip == 'false' && steps.detect-sonar-type.outputs.is_sonarcloud == 'false'
      shell: bash
      env:
        SONAR_TOKEN: ${{ inputs.sonar_token }}
      run: |
        echo "ğŸš€ Starting SonarQube analysis..."
        echo "   Server: ${{ inputs.sonar_host_url }}"

        dotnet sonarscanner begin \
          /k:"${{ inputs.sonar_project_key }}" \
          /d:sonar.host.url="${{ inputs.sonar_host_url }}" \
          /d:sonar.token="${SONAR_TOKEN}" \
          /d:sonar.cs.vscoveragexml.reportsPaths="coverage.xml" \
          /d:sonar.coverage.exclusions="${{ inputs.coverage_exclusions }}"

        echo "âœ… SonarQube analysis initialized"

    - name: ğŸ—ï¸ Build Solution
      if: steps.check-skip.outputs.skip == 'false'
      shell: bash
      run: |
        echo "ğŸ—ï¸ Building solution..."
        dotnet build ${{ inputs.solution_path }} --configuration Release --no-restore
        echo "âœ… Build completed"

    - name: ğŸ§ª Run Tests with Coverage
      if: steps.check-skip.outputs.skip == 'false'
      shell: bash
      run: |
        echo "ğŸ§ª Running tests with code coverage..."

        dotnet-coverage collect \
          "dotnet test ${{ inputs.solution_path }} --configuration Release --no-build --verbosity minimal" \
          -f xml \
          -o "coverage.xml"

        echo "âœ… Tests completed with coverage"

    - name: ğŸ End Sonar Analysis
      if: steps.check-skip.outputs.skip == 'false'
      id: sonar-end
      shell: bash
      env:
        SONAR_TOKEN: ${{ inputs.sonar_token }}
      run: |
        echo "ğŸ Finishing Sonar analysis..."

        dotnet sonarscanner end /d:sonar.token="${SONAR_TOKEN}"

        echo "âœ… Sonar analysis completed"
        echo "quality_gate_status=NONE" >> $GITHUB_OUTPUT

    - name: ğŸ“Š Display Results (SonarCloud)
      if: steps.check-skip.outputs.skip == 'false' && steps.detect-sonar-type.outputs.is_sonarcloud == 'true'
      shell: bash
      run: |
        echo "ğŸ“Š SonarCloud Analysis Complete"
        echo ""
        echo "ğŸ”— View detailed results at:"
        echo "   https://sonarcloud.io/project/overview?id=${{ inputs.sonar_project_key }}"
        echo ""
        echo "ğŸ“ˆ Quality metrics will appear in ~1-2 minutes"

    - name: ğŸ“Š Display Results (SonarQube)
      if: steps.check-skip.outputs.skip == 'false' && steps.detect-sonar-type.outputs.is_sonarcloud == 'false'
      shell: bash
      run: |
        echo "ğŸ“Š SonarQube Analysis Complete"
        echo ""
        echo "ğŸ”— View detailed results at:"
        echo "   ${{ inputs.sonar_host_url }}/dashboard?id=${{ inputs.sonar_project_key }}"
        echo ""
        echo "ğŸ“ˆ Quality metrics will appear in ~1-2 minutes"

    - name: â­ï¸ Skipped Analysis
      if: steps.check-skip.outputs.skip == 'true'
      shell: bash
      run: |
        echo "â­ï¸  Sonar analysis was skipped"
        echo "â„¹ï¸  To enable, set skip_analysis=false"

branding:
  icon: 'shield'
  color: 'orange'
